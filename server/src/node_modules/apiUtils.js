import { query } from "dbUtils"
import { getJson} from "fetchUtils"

const selectQuery = (q, url) => (req, res, next) => query(
	q,
	[req.vars.query],
	async ans => {
		if(ans.length) res.json(await getJson(req.rootUrl +"/"+ url +"/"+ ans[0].id));
		else res.status(404).json({error: "not found"});
	});

const idQuery = q => (req, res, next) => query(
	q,
	[req.vars.id],
	async ans => {
		if(ans.length) res.json({"@self": {url:req.currentUrl, type:"object"},...ans[0]});
		else res.status(404).json({error: "not found"});
	});

const searchQuery = (q, url) => (req, res, next) => query(
	q,
	[req.vars.query],
	async ans => {
		if (ans.length)
			res.json({
				"@self": { url: req.currentUrl, type: "collection" },
				collection: ans.map(item =>req.rootUrl +"/"+ url +"/"+ item.id)
			});
		else res.status(404).json({error: "not found"});
	});

export { selectQuery, idQuery, searchQuery };